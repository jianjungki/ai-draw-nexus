import{av as y,aw as D}from"./index-BsZN8iTB.js";import{E as nt}from"./elk.bundled-B4i-Ysuq.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";var R=y((h,p,{parentById:g})=>{const k=new Set;let w=h;if(h===p)return g[h]||"root";for(;w;){if(k.add(w),w===p)return w;w=g[w]}for(w=p;w;){if(k.has(w))return w;w=g[w]}return"root"},"findCommonAncestor"),H=1e-4;function _(h,p){return!h||!p?0:Math.sqrt(Math.pow(p.x-h.x,2)+Math.pow(p.y-h.y,2))}y(_,"distance");var ht=y(async(h,p,{common:g,getConfig:k,insertCluster:w,insertEdge:W,insertEdgeLabel:L,insertMarkers:V,insertNode:U,interpolateToCurve:S,labelHelper:$,log:l,positionEdgeLabel:J},{algorithm:B})=>{const f={},K={},q=y(async(e,t,a,s)=>{const c={width:0,height:0},o=k();if(s.isGroup){const i={...s,children:[]};if(t.children.push(i),f[s.id]=i,await v(e,a,i,s.id),s.label){const{shapeSvg:n,bbox:d}=await $(e,s,void 0,!0);c.width=d.width,c.wrappingWidth=o.flowchart.wrappingWidth,c.height=d.height-2,c.labelNode=n.node(),n.remove()}else c.width=0,c.height=0;i.labelData=c,i.domId=e}else{const i={id:s.id,width:s.width,height:s.height,label:s.label,isGroup:s.isGroup,shape:s.shape,padding:s.padding,cssClasses:s.cssClasses,cssStyles:s.cssStyles,look:s.look,parentId:s.parentId};t.children.push(i),f[s.id]=i;const n=await U(e,s,{config:o,dir:s.dir}),d=n.node().getBBox();i.domId=n,i.calcIntersect=s.calcIntersect,i.width=d.width,i.height=d.height}},"addVertex"),v=y(async function(e,t,a,s){const c=t.filter(o=>o?.parentId===s);return l.info("addVertices APA12",c,s),await Promise.all(c.map(async o=>{await q(e,a,t,o)})),a},"addVertices"),T=y(async(e,t,a,s,c,o)=>{await Promise.all(a.map(async function(i){if(i)if(f[i.id]=i,f[i.id].offset={posX:i.x+e,posY:i.y+t,x:e,y:t,depth:o,width:Math.max(i.width,i.labels&&i.labels[0]?.width||0),height:i.height},i.isGroup){l.debug("id abc88 subgraph = ",i.id,i.x,i.y,i.labelData);const n=c.insert("g").attr("class","subgraph"),d=JSON.parse(JSON.stringify(i));d.x=i.offset.posX+i.width/2,d.y=i.offset.posY+i.height/2,d.width=Math.max(d.width,i.labelData.width),await w(n,d),l.debug("id (UIO)= ",i.id,i.width,i.shape,i.labels)}else l.info("id NODE = ",i.id,i.x,i.y,e,t,i.domId.node(),`translate(${i.x+e+i.width/2}, ${i.y+t+i.height/2})`),i.domId.attr("transform",`translate(${i.x+e+i.width/2}, ${i.y+t+i.height/2})`)})),await Promise.all(a.map(async function(i){i?.isGroup&&await T(e+i.x,t+i.y,i.children,s,c,o+1)}))},"drawNodes"),z=y(e=>{const t={parentById:{},childrenById:{}},a=e.filter(s=>s.isGroup);return l.info("Subgraphs - ",a),a.forEach(s=>{e.filter(o=>o.parentId===s.id).forEach(o=>{t.parentById[o.id]=s.id,t.childrenById[s.id]===void 0&&(t.childrenById[s.id]=[]),t.childrenById[s.id].push(o)})}),a.forEach(function(s){s.id,t.parentById[s.id]!==void 0&&t.parentById[s.id]}),t},"addSubGraphs"),j=y(e=>{const t=e.start,a=e.end,s=t,c=a,o=f[e.start.id],i=f[e.end.id];return!o||!i?{source:t,target:a}:{source:t,target:a,sourceId:s,targetId:c}},"getEdgeStartEndPoint"),Q=y(function(e,t,a){const s=R(e,t,a);if(s===void 0||s==="root")return{x:0,y:0};const c=f[s].offset;return{x:c.posX,y:c.posY}},"calcOffset"),X=y(async function(e,t,a){l.info("abc78 DAGA edges = ",e);const s=e.edges,c=a.insert("g").attr("class","edgeLabels"),o={},i=e.direction||"DOWN";return await Promise.all(s.map(async function(n){const d=n.id;o[d]===void 0?(o[d]=0,l.info("abc78 new entry",d,o[d])):(o[d]++,l.info("abc78 new entry",d,o[d]));const E=d+"_"+o[d];n.id=E,l.info("abc78 new link id to be used is",d,E,o[d]);const O="LS_"+n.start,P="LE_"+n.end,r={style:"",labelStyle:""};switch(r.minlen=n.length||1,n.text=n.label,n.type==="arrow_open"?r.arrowhead="none":r.arrowhead="normal",r.arrowTypeStart="arrow_open",r.arrowTypeEnd="arrow_open",n.type){case"double_arrow_cross":r.arrowTypeStart="arrow_cross";case"arrow_cross":r.arrowTypeEnd="arrow_cross";break;case"double_arrow_point":r.arrowTypeStart="arrow_point";case"arrow_point":r.arrowTypeEnd="arrow_point";break;case"double_arrow_circle":r.arrowTypeStart="arrow_circle";case"arrow_circle":r.arrowTypeEnd="arrow_circle";break}let A="",b="";switch(r.startLabelRight=n.startLabelRight,r.endLabelLeft=n.endLabelLeft,n.stroke){case"normal":A="fill:none;",r.thickness="normal",r.pattern="solid";break;case"dotted":r.thickness="normal",r.pattern="dotted",r.style="fill:none;stroke-width:2px;stroke-dasharray:3;";break;case"thick":r.thickness="thick",r.pattern="solid",r.style="stroke-width: 3.5px;fill:none;";break}r.style=r.style+=A,r.labelStyle=r.labelStyle+=b;const st=k();n.interpolate!==void 0?r.curve=S(n.interpolate,D):s.defaultInterpolate!==void 0?r.curve=S(s.defaultInterpolate,D):r.curve=S(st.curve,D),n.text===void 0?n.style!==void 0&&(r.arrowheadStyle="fill: #333"):(r.arrowheadStyle="fill: #333",r.labelpos="c"),r.labelType=n.labelType,r.label=(n?.text||"").replace(g.lineBreakRegex,`
`),n.style===void 0&&(r.style=r.style||"stroke: #333; stroke-width: 1.5px;fill:none;"),r.labelStyle=r.labelStyle.replace("color:","fill:"),r.id=E,r.classes="flowchart-link "+O+" "+P;const it=await L(c,r),{source:M,target:C,sourceId:rt,targetId:at}=j(n,i);l.debug("abc78 source and target",M,C),t.edges.push({id:"e"+n.start+n.end,...n,sources:[M],targets:[C],sourceId:rt,targetId:at,labelEl:it,labels:[{width:r.width,height:r.height,orgWidth:r.width,orgHeight:r.height,text:r.label,layoutOptions:{"edgeLabels.inline":"true","edgeLabels.placement":"CENTER"}}],edgeData:r})})),t},"addEdges");function N(e){switch(e){case"LR":return"RIGHT";case"RL":return"LEFT";case"TB":return"DOWN";case"BT":return"UP";default:return"DOWN"}}y(N,"dir2ElkDirection");function m(e,t){const a=f[e];a&&(a?.layoutOptions===void 0&&(a.layoutOptions={}),a.layoutOptions["elk.hierarchyHandling"]="INCLUDE_CHILDREN",a.id!==t&&m(a.parentId,t))}y(m,"setIncludeChildrenPolicy");const G=new nt,Y=p.select("g");V(Y,h.markers,h.type,h.diagramId);let u={id:"root",layoutOptions:{"elk.hierarchyHandling":"INCLUDE_CHILDREN","elk.layered.crossingMinimization.forceNodeModelOrder":h.config.elk?.forceNodeModelOrder,"elk.layered.considerModelOrder.strategy":h.config.elk?.considerModelOrder,"elk.algorithm":B,"nodePlacement.strategy":h.config.elk?.nodePlacementStrategy,"elk.layered.mergeEdges":h.config.elk?.mergeEdges,"elk.direction":"DOWN","spacing.baseValue":35,"elk.layered.unnecessaryBendpoints":!0,"elk.layered.cycleBreaking.strategy":h.config.elk?.cycleBreakingStrategy},children:[],edges:[]};l.info("Drawing flowchart using v4 renderer",G);const Z=h.direction||"DOWN";u.layoutOptions["elk.direction"]=N(Z);const x=z(h.nodes),F=p.insert("g").attr("class","subgraphs"),tt=p.insert("g").attr("class","nodes");u=await v(tt,h.nodes,u);const et=p.insert("g").attr("class","edges edgePaths");u=await X(h,u,p),h.nodes.forEach(e=>{const t=f[e.id];x.childrenById[t.id]!==void 0&&(t.labels=[{text:t.label,width:t?.labelData?.width||50,height:t?.labelData?.height||50},t.width=t.width+2*t.padding,l.debug("UIO node label",t?.labelData?.width,t.padding)],t.layoutOptions={"spacing.baseValue":30,"nodeLabels.placement":"[H_CENTER V_TOP, INSIDE]"},t.dir&&(t.layoutOptions={...t.layoutOptions,"elk.algorithm":B,"elk.direction":N(t.dir),"nodePlacement.strategy":h.config.elk?.nodePlacementStrategy,"elk.layered.mergeEdges":h.config.elk?.mergeEdges,"elk.hierarchyHandling":"SEPARATE_CHILDREN"}),delete t.x,delete t.y,delete t.width,delete t.height)}),l.debug("APA01 processing edges, count:",u.edges.length),u.edges.forEach((e,t)=>{l.debug("APA01 processing edge",t,":",e);const a=e.sources[0],s=e.targets[0];if(l.debug("APA01 source:",a,"target:",s),l.debug("APA01 nodeDb[source]:",f[a]),l.debug("APA01 nodeDb[target]:",f[s]),f[a]&&f[s]&&f[a].parentId!==f[s].parentId){const c=R(a,s,x);m(a,c),m(s,c)}}),l.debug("APA01 before"),l.debug("APA01 elkGraph structure:",JSON.stringify(u,null,2)),l.debug("APA01 elkGraph.children length:",u.children?.length),l.debug("APA01 elkGraph.edges length:",u.edges?.length),u.edges?.forEach((e,t)=>{l.debug(`APA01 validating edge ${t}:`,e),e.sources&&e.sources.forEach(a=>{const s=u.children?.some(c=>c.id===a);l.debug(`APA01 source ${a} exists:`,s)}),e.targets&&e.targets.forEach(a=>{const s=u.children?.some(c=>c.id===a);l.debug(`APA01 target ${a} exists:`,s)})});let I;try{I=await G.layout(u),l.debug("APA01 after - success"),l.debug("APA01 layout result:",JSON.stringify(I,null,2))}catch(e){throw l.error("APA01 ELK layout error:",e),e}await T(0,0,I.children,p,F,0),I.edges?.map(e=>{const t=f[e.sources[0]],a=x[e.sources[0]],s=f[e.targets[0]],c=e.start,o=e.end,i=Q(c,o,x);if(l.debug("APA18 offset",i,c," ==> ",o,"edge:",e,"cluster:",a,t),e.sections){const n=e.sections[0].startPoint,d=e.sections[0].endPoint,O=(e.sections[0].bendPoints?e.sections[0].bendPoints:[]).map(b=>({x:b.x+i.x,y:b.y+i.y}));e.points=[{x:n.x+i.x,y:n.y+i.y},...O,{x:d.x+i.x,y:d.y+i.y}];let P=t.width,r=s.width;if(t.isGroup){const b=t.domId.node().getBBox();P=Math.max(t.width,t.labels[0].width+t.padding),l.debug("UIO width",t.id,t.with,"bbox.width=",b.width,"lw=",t.labels[0].width,"node:",t.width,"SW = ",P)}if(s.isGroup){const b=s.domId.node().getBBox();r=Math.max(s.width,s.labels[0].width+s.padding),l.debug("UIO width",t.id,t.with,b.width,"EW = ",r,"HTML:",t.innerHTML)}if(t.calcIntersect){const b=t.calcIntersect({x:t.offset.posX+t.width/2,y:t.offset.posY+t.height/2,width:t.width,height:t.height},e.points[0]);_(b,e.points[0])>H&&e.points.unshift(b)}if(s.calcIntersect){const b=s.calcIntersect({x:s.offset.posX+s.width/2,y:s.offset.posY+s.height/2,width:s.width,height:s.height},e.points[e.points.length-1]);_(b,e.points[e.points.length-1])>H&&e.points.push(b)}const A=W(et,e,K,h.type,t,s,h.diagramId);e.x=e.labels[0].x+i.x+e.labels[0].width/2,e.y=e.labels[0].y+i.y+e.labels[0].height/2,J(e,A)}})},"render");export{ht as render};
